<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Profile | Total Connect NFC</title>
    <meta name="description" content="Create, manage, and share digital business cards using NFC technology.">
    <meta name="image" content="https://tccards.tn/Assets/4.png">
    <meta property="og:image" content="https://tccards.tn/Assets/4.png">
    <link rel="icon" href="https://tccards.tn/Assets/150.png" type="image/x-icon">
    <meta property="og:image:width" content="1200">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link href="https://cdn.tailwindcss.com" rel="stylesheet">
    <link rel="preload" href="https://tccards.tn/Assets/bg.png" as="image">
    <link rel="preload" href="https://cdn.tailwindcss.com" as="script">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css">
    <link rel="stylesheet" href="style.css">
<style>
    .loader {
        border: 5px solid #f3f3f3;
        border-top: 5px solid #3498db;
        border-radius: 50%;
        width: 50px;
        height: 50px;
        animation: spin 1s linear infinite;
        margin: 20px auto;
    }
    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }
</style>
</head>
<body>
<div class="loader"></div>
<div class="card-container" style="display:none;"></div>

<script>
document.addEventListener("DOMContentLoaded", function() {
    const hash = window.location.hash.substring(1);
    if (!hash) return showError("Invalid profile link");
    
    // Try both ID and link formats
    const identifier = hash.includes('_') ? hash.split('_')[1] : hash;
    const isIdLookup = hash.startsWith('id_');
    
    fetchProfile(identifier, isIdLookup);
});

function fetchProfile(identifier, isIdLookup = false) {
    const callbackName = `profileCallback_${Date.now()}`;
    window[callbackName] = function(data) {
        delete window[callbackName];
        handleProfileData(data);
    };

    const script = document.createElement('script');
    const param = isIdLookup ? 'id' : 'link';
    script.src = `https://script.google.com/macros/s/AKfycbyIszo8lC3xYgvAGIO6wJuOPY9tzOd-s0eH1l-X9ZHTMdyxU70Otlz7EPNV7CbmeuSWwQ/exec?${param}=${encodeURIComponent(identifier)}&callback=${callbackName}`;
    script.onerror = () => showError("Failed to load profile data");
    document.head.appendChild(script);
}

function handleProfileData(data) {
    document.querySelector('.loader').style.display = 'none';
    const container = document.querySelector('.card-container');
    
    if (!data || data.status === 'error') {
        return showError(data?.message || "Profile not found");
    }

    container.style.display = 'block';
    container.innerHTML = `
        <!-- Your profile rendering HTML here -->
        <div class="profile-container">
            <h2>${escapeHtml(data.Name)}</h2>
            <!-- Rest of your template -->
        </div>
    `;
}

function showError(message) {
    document.querySelector('.loader').style.display = 'none';
    document.querySelector('.card-container').innerHTML = `
        <div class="error">
            <h3>Error</h3>
            <p>${escapeHtml(message)}</p>
            <a href="/">Go Home</a>
        </div>
    `;
}

function escapeHtml(unsafe) {
    return unsafe.toString()
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;")
        .replace(/"/g, "&quot;")
        .replace(/'/g, "&#039;");
}
</script>
</body>
</html>
